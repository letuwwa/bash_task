function diskInput {
  echo "<----disk input---->" >> file.log
  read -p "Input name of disk: " value
  if lsblk -f | grep -wq $value; then
      echo "<---correct disk $value--->" >> file.log
      (echo n; echo p; echo 1; echo ; echo ; echo t; echo fd; echo w) | fdisk /dev/$value
      echo $value
   else
      echo "<---incorrect disk $value--->" >> file.log
      echo Disk doesnt exist
  fi
}

function main {
 echo "<---trying check config file--->" >> file.log
 configFile=/etc/sysconfig/network-scripts/ifcfg-enp0s3
 if grep -q ONBOOT=yes $configFile
  then echo "ONBOOT=yes, config is corect"
  echo "<---config file is correct--->" >> file.log
 else
  echo "<---config file is incorrect, rewriting--->" >> file.log
  grep "ONBOOT=no" -P -R -I -l $configFile | xargs sed -i 's/ONBOOT=no/ONBOOT=yes/g'
  echo "ONBOOT setted on YES, config is changed"
 fi
 
 echo "<---trying check sshd file--->" >> file.log
 sshdConfig=/etc/ssh/sshd_config
 if grep -q 'PermitRootLogin no' $sshdConfig
  then echo 'PermitRootLogin no, config is correct'
  echo "<---sshd file is correct--->" >> file.log
 else
  echo "<---sshd file is incorrect, rewriting--->" >> file.log
  echo "PermitRootLogin setted on NO, config is changed"
  grep '#PermitRootLogin yes' -P -R -I -l $sshdConfig | xargs sed -i 's/#PermitRootLogin yes/PermitRootLogin no/g'
 fi
 
 echo "<---trying to block port, leave 22 only--->" >> file.log
 iptables -A INPUT -p tcp --dport 22 -j ACCEPT
 
 echo "<---trying to disable repositories--->" >> file.log
 yum update -y --disablerepo=*
 
 echo "<---trying to check repo file--->" >> file.log
 repoFile=/etc/yum.repos.d/mnt_iso_.repo
 if [ -f "$repoFile" ];
 then
    echo "File $repoFile exist, repo is enabled"
    echo "<---repo file is exist--->" >> file.log
 else
    echo "<---repo file doesn't exist, starting to create...--->" >> file.log
    mkdir -p /mnt/iso
    mount -o loop CentOS-7-x86_64-DVD-2009.iso /mnt/iso
    yum-config-manager --add-repo=file:///mnt/iso
    echo "File $repoFile does not exist, repo created and enabled"
    echo "<---repo file is created...--->" >> file.log
 fi
 
 echo "<---trying to get mount point name--->" >> file.log
 echo "Input mount point name to mount:"
 read mountPoint
 if mdadm --detail --scan --verbose | grep -q /dev/$mountPoint
 then
     echo $mountPoint alredy exist!
 else
     disk1=$(diskInput)
     echo "<---disk 1 input $disk1--->" >> file.log
     disk2=$(diskInput)
     echo "<---disk 2 input $disk2--->" >> file.log
     disk3=$(diskInput)
     echo "<---disk 3 input $disk3--->" >> file.log
     
     echo "<---trying to create RAID--->" >> file.log
     mdadm --create /dev/$mountPoint --level=5 --raid-devices=3 /dev/$disk1 /dev/$disk2 /dev/$disk3
     echo "<---trying to set up file system--->" >> file.log
     pvcreate /dev/$mountPoint
     mkfs.ext4 /dev/$mountPoint
     mount /dev/$mountPoint /mnt
 fi
 
 echo "<---trying to enable rpcbind--->" >> file.log
 systemctl enable rpcbind
 
 echo "<---trying to enable nfs-server--->" >> file.log
 systemctl enable nfs-server
 
 echo "<---trying to enable nfs-lock--->" >> file.log
 systemctl enable nfs-lock
 
 echo "<---trying to enable nfs-idmap--->" >> file.log
 systemctl enable nfs-idmap
 
 echo "<---trying to start rpcbind--->" >> file.log
 systemctl start rpcbind
 
 echo "<---trying to start nfs-server--->" >> file.log
 systemctl start nfs-server
 
 echo "<---trying to start nfs-lock--->" >> file.log
 systemctl start nfs-lock
 
 echo "<---trying to start nfs-idmap--->" >> file.log
 systemctl start nfs-idmap
 
 echo "<---trying to share folder--->" >> file.log
 mkdir -p /home/nfs
 chmod -R 777 /home/nfs
 echo "<---setup nfs shared foler with 192.168.56.1 ip adress--->" >> file.log
 echo "192.168.56.1(rw,sync,no_root_squash,no_all_squash)" >> /etc/exports 
 echo "<---restart nfs server--->" >> file.log
 systemctl restart nfs-server
}

main 2>&1 | tee -a file.log
